# DearTs 应用程序运行流程图

## 整体架构

```mermaid
graph TD
    A[main函数] --> B[设置控制台UTF-8支持]
    B --> C[设置全局异常处理器]
    C --> D[打印应用程序信息]
    D --> E[初始化DearTs核心系统]
    E --> F{初始化成功?}
    F -->|否| G[返回错误码-1]
    F -->|是| H[注册全局事件监听器]
    H --> I[创建窗口配置]
    I --> J[创建窗口对象]
    J --> K[创建SDL窗口]
    K --> L{创建成功?}
    L -->|否| M[关闭核心系统并返回-1]
    L -->|是| N[将窗口添加到窗口管理器]
    N --> O[创建渲染上下文]
    O --> P{创建成功?}
    P -->|否| Q[关闭核心系统并返回-1]
    P -->|是| R[设置当前渲染上下文]
    R --> S[设置窗口渲染器]
    S --> T[初始化资源管理器]
    T --> U[加载默认字体]
    U --> V[初始化ImGui]
    V --> W{初始化成功?}
    W -->|否| X[关闭核心系统并返回-1]
    W -->|是| Y[获取应用程序管理器]
    Y --> Z[创建并运行应用程序]
    Z --> AA[关闭核心系统]
    AA --> AB[返回退出码]
    
    %% 异常处理路径
    G --> AC[main函数结束]
    M --> AC
    Q --> AC
    X --> AC
    AB --> AC
```

## 详细流程说明

### 1. 应用程序启动阶段

```mermaid
sequenceDiagram
    participant M as main函数
    participant C as 控制台设置
    participant E as 异常处理
    participant I as 应用信息
    
    M->>C: setupConsoleUTF8()
    C-->>M: 完成UTF-8支持设置
    M->>E: setupGlobalExceptionHandler()
    E-->>M: 设置全局异常处理器
    M->>I: printApplicationInfo()
    I-->>M: 显示应用程序信息
```

### 2. 核心系统初始化

```mermaid
sequenceDiagram
    participant M as main函数
    participant D as DearTs::Core
    participant L as 日志系统
    participant S as SDL子系统
    participant E as 各管理器
    
    M->>D: DearTs::Core::init()
    D->>L: 初始化日志系统
    D->>S: 初始化SDL (视频/音频/控制器等)
    D->>E: 依次初始化各管理器
    E-->>D: 管理器初始化完成
    D-->>M: 核心系统初始化结果
```

### 3. 窗口和渲染系统初始化

```mermaid
sequenceDiagram
    participant M as main函数
    participant W as 窗口管理器
    participant R as 渲染管理器
    participant I as ImGui
    
    M->>W: 创建窗口配置和窗口对象
    M->>W: window->create()
    W-->>M: 窗口创建结果
    M->>W: 将窗口添加到窗口管理器
    M->>R: 创建渲染上下文
    R-->>M: 渲染上下文创建结果
    M->>R: 设置当前渲染上下文
    M->>W: 设置窗口渲染器(使用适配器)
    M->>R: 初始化资源管理器和字体
    M->>I: 初始化ImGui
    I-->>M: ImGui初始化结果
```

### 4. 应用程序运行阶段

```mermaid
sequenceDiagram
    participant M as main函数
    participant A as 应用程序管理器
    participant App as 应用程序
    
    M->>A: 获取应用程序管理器实例
    M->>A: 创建应用程序实例
    A->>App: appManager.runApplication()
    loop 应用程序主循环
        App->>App: 处理事件
        App->>App: 更新状态
        App->>App: 渲染界面
    end
    App-->>A: 返回运行结果
    A-->>M: 应用程序运行结果
```

### 5. 系统关闭阶段

```mermaid
sequenceDiagram
    participant M as main函数
    participant D as DearTs::Core
    participant E as 各管理器
    participant S as SDL子系统
    
    M->>D: DearTs::Core::shutdown()
    D->>E: 按相反顺序关闭各管理器
    D->>S: 关闭SDL子系统(TTF/音频/图像/SDL)
    D->>L: 保存配置并关闭日志系统
    D-->>M: 核心系统关闭完成
```

## GUI子系统完整生命周期架构 (main/gui)

### GUI架构概览

```mermaid
graph TD
    A[ApplicationManager] --> B[WindowManager]
    A --> C[ImGui集成]
    A --> D[事件系统]
    A --> E[插件系统]
    A --> F[资源管理]
    
    B --> G[自定义标题栏]
    B --> H[窗口控制]
    B --> I[搜索功能]
```

### ApplicationManager 生命周期

```mermaid
graph LR
    A[构造函数] --> B[initialize()]
    B --> C{初始化成功?}
    C -->|是| D[run()]
    C -->|否| E[返回错误]
    D --> F{主循环}
    F --> G[processEvents()]
    F --> H[update()]
    F --> I[render()]
    F --> J{是否退出?}
    J -->|否| F
    J -->|是| K[shutdown()]
```

### WindowManager 初始化流程

```mermaid
sequenceDiagram
    participant AM as ApplicationManager
    participant WM as WindowManager
    participant SDL as SDL
    participant WIN as Windows API
    
    AM->>WM: new WindowManager(window)
    AM->>WM: initialize()
    WM->>WM: getHWND()
    WM->>WIN: 获取Windows窗口句柄
    WIN-->>WM: HWND
    WM->>WM: setBorderlessStyle()
    WM->>WIN: 设置无边框样式
    WM->>WM: saveWindowState()
    WM->>WM: registerEventHandlers()
    WM-->>AM: 初始化结果
```

### 主循环处理流程

```mermaid
graph TD
    A[主循环] --> B[processEvents()]
    B --> C[事件处理]
    C --> D[SDL事件轮询]
    D --> E{事件类型}
    E --> F[鼠标事件]
    E --> G[键盘事件]
    E --> H[窗口事件]
    E --> I[ImGui事件]
    
    F --> J[WindowManager.handleEvent()]
    J --> K[拖拽处理]
    J --> L[按钮点击]
    
    G --> M[快捷键处理]
    G --> N[搜索对话框]
    
    H --> O[最小化/最大化]
    H --> P[窗口关闭]
    
    I --> Q[ImGui内部处理]
    
    A --> R[update()]
    R --> S[状态更新]
    S --> T[插件更新]
    S --> U[事件发布]
    
    A --> V[render()]
    V --> W[清屏]
    V --> X[ImGui新帧]
    V --> Y[标题栏渲染]
    V --> Z[主界面渲染]
    V --> AA[插件界面渲染]
    V --> AB[ImGui渲染]
    V --> AC[SDL呈现]
```

### 窗口控制功能

```mermaid
graph LR
    A[窗口控制] --> B[最小化]
    A --> C[最大化/还原]
    A --> D[关闭]
    A --> E[拖拽移动]
    A --> F[搜索功能]
    
    B --> G[SDL_MinimizeWindow]
    C --> H[SDL_RestoreWindow/SDL_MaximizeWindow]
    D --> I[SDL_QUIT事件]
    E --> J[鼠标拖拽处理]
    F --> K[Ctrl+F快捷键]
```

## 关键组件说明

### 核心管理器初始化顺序

1. **日志管理器** - 提供日志输出功能
2. **配置管理器** - 管理应用程序配置
3. **性能分析器** - 提供性能监控功能
4. **SDL库** - 初始化视频、音频等子系统
5. **事件系统** - 处理应用程序事件
6. **窗口管理器** - 管理应用程序窗口
7. **渲染管理器** - 管理渲染上下文和渲染器
8. **输入管理器** - 处理用户输入
9. **资源管理器** - 管理应用程序资源
10. **音频管理器** - 处理音频播放
11. **应用程序管理器** - 管理应用程序生命周期

### 窗口和渲染系统架构

```mermaid
graph LR
    A[Window对象] --> B[WindowRenderer接口]
    B --> C[IRendererToWindowRendererAdapter适配器]
    C --> D[SDLRenderer实现]
    D --> E[SDL_Renderer]
    D --> F[ImGui集成]
```

### GUI子系统架构

```mermaid
graph LR
    A[ApplicationManager] --> B[初始化SDL]
    A --> C[初始化ImGui]
    A --> D[初始化WindowManager]
    A --> E[初始化资源管理]
    A --> F[初始化插件系统]
    A --> G[注册事件处理器]
    
    B --> H[创建窗口和渲染器]
    C --> I[ImGui上下文和绑定]
    D --> J[无边框窗口设置]
    E --> K[字体和资源加载]
    F --> L[插件加载和管理]
    G --> M[事件订阅]
```

### 异常处理机制

1. **全局异常处理器** - 捕获未处理的异常并显示错误信息
2. **各阶段错误检查** - 每个关键步骤都会检查执行结果
3. **资源清理** - 出错时会自动清理已分配的资源

## 应用程序生命周期

```mermaid
graph LR
    A[启动] --> B[初始化]
    B --> C[运行]
    C --> D{退出请求?}
    D -->|否| C
    D -->|是| E[关闭]
    E --> F[退出]
```

这个流程图展示了DearTs应用程序从启动到退出的完整生命周期，包括了所有关键的初始化步骤、运行时循环以及系统关闭过程。GUI子系统的完整生命周期架构也已详细说明，展示了ApplicationManager和WindowManager如何协同工作来提供现代化的用户界面体验。